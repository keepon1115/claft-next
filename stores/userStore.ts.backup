'use client'

import { create } from 'zustand'
import { devtools, persist } from 'zustand/middleware'
import { immer } from 'zustand/middleware/immer'
import { createBrowserSupabaseClient, safeSupabaseQuery } from '@/lib/supabase/client'
import type { UserProfile, UserStats } from '@/types'

// =====================================================
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–¢é€£ã®åž‹å®šç¾©
// =====================================================

export interface ProfileData {
  nickname: string
  character: string
  skills: string[]
  weakness: string
  favoritePlace: string
  energyCharge: string
  companion: string
  catchphrase: string
  message: string
  avatarUrl?: string
  profileCompletion: number
}

export interface ExtendedUserStats {
  // åŸºæœ¬çµ±è¨ˆ
  userId: string
  loginCount: number
  lastLoginDate: string
  totalPlayTime: number
  level: number
  experience: number
  experienceToNext: number
  
  // ã‚¯ã‚¨ã‚¹ãƒˆé–¢é€£
  questsCompleted: number
  questsInProgress: number
  currentStreak: number
  maxStreak: number
  
  // ãƒãƒƒã‚¸ãƒ»å®Ÿç¸¾
  achievementCount: number
  goldBadges: number
  silverBadges: number
  bronzeBadges: number
  
  // ä½œæˆãƒ»æ›´æ–°æ—¥æ™‚
  createdAt: string
  updatedAt: string
}

export interface Achievement {
  id: string
  title: string
  description: string
  type: 'gold' | 'silver' | 'bronze'
  iconClass: string
  unlockedAt?: string
  isUnlocked: boolean
}

export interface UserActivity {
  id: string
  userId: string
  activityType: 'login' | 'quest_complete' | 'profile_update' | 'level_up'
  description: string
  experienceGained?: number
  timestamp: string
}

// =====================================================
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆã‚¢ã®åž‹å®šç¾©
// =====================================================

interface UserState {
  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±
  profileData: ProfileData
  extendedStats: ExtendedUserStats | null
  achievements: Achievement[]
  recentActivities: UserActivity[]
  
  // çŠ¶æ…‹ç®¡ç†
  isLoading: boolean
  isSaving: boolean
  error: string | null
  lastSyncTime: string | null
  isInitialized: boolean
  
  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  initialize: (userId: string) => Promise<void>
  updateProfile: (updates: Partial<ProfileData>) => Promise<{ success: boolean; error?: string }>
  updateStats: (updates: Partial<ExtendedUserStats>) => Promise<{ success: boolean; error?: string }>
  addExperience: (amount: number, reason?: string) => Promise<{ success: boolean; levelUp?: boolean; error?: string }>
  recordActivity: (activityType: UserActivity['activityType'], description: string, experienceGained?: number) => Promise<void>
  unlockAchievement: (achievementId: string) => Promise<{ success: boolean; error?: string }>
  calculateProfileCompletion: () => number
  autoSave: () => Promise<void>
  syncWithSupabase: () => Promise<void>
  resetProfile: () => void
  clearError: () => void
}

// =====================================================
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
// =====================================================

const defaultProfileData: ProfileData = {
  nickname: 'å†’é™ºè€…',
  character: '',
  skills: [],
  weakness: '',
  favoritePlace: '',
  energyCharge: '',
  companion: '',
  catchphrase: '',
  message: '',
  avatarUrl: '',
  profileCompletion: 0,
}

const defaultExtendedStats: ExtendedUserStats = {
  userId: '',
  loginCount: 0,
  lastLoginDate: '',
  totalPlayTime: 0,
  level: 1,
  experience: 0,
  experienceToNext: 100,
  questsCompleted: 0,
  questsInProgress: 0,
  currentStreak: 0,
  maxStreak: 0,
  achievementCount: 0,
  goldBadges: 0,
  silverBadges: 0,
  bronzeBadges: 0,
  createdAt: new Date().toISOString(),
  updatedAt: new Date().toISOString(),
}

// äº‹å‰å®šç¾©ã•ã‚ŒãŸå®Ÿç¸¾
const predefinedAchievements: Achievement[] = [
  {
    id: 'first_login',
    title: 'åˆå›žãƒ­ã‚°ã‚¤ãƒ³',
    description: 'CLAFTã¸ã‚ˆã†ã“ãï¼',
    type: 'bronze',
    iconClass: 'fa-star',
    isUnlocked: false,
  },
  {
    id: 'profile_complete',
    title: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œæˆ',
    description: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’100%å®Œæˆã•ã›ãŸ',
    type: 'silver',
    iconClass: 'fa-user-check',
    isUnlocked: false,
  },
  {
    id: 'first_quest',
    title: 'åˆã‚¯ã‚¨ã‚¹ãƒˆ',
    description: 'æœ€åˆã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ãŸ',
    type: 'bronze',
    iconClass: 'fa-flag-checkered',
    isUnlocked: false,
  },
  {
    id: 'quest_master',
    title: 'ã‚¯ã‚¨ã‚¹ãƒˆãƒžã‚¹ã‚¿ãƒ¼',
    description: '10å€‹ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ãŸ',
    type: 'gold',
    iconClass: 'fa-crown',
    isUnlocked: false,
  },
  {
    id: 'level_10',
    title: 'ãƒ¬ãƒ™ãƒ«10é”æˆ',
    description: 'ãƒ¬ãƒ™ãƒ«10ã«åˆ°é”ã—ãŸ',
    type: 'silver',
    iconClass: 'fa-level-up-alt',
    isUnlocked: false,
  },
  {
    id: 'streak_7',
    title: '7æ—¥é€£ç¶š',
    description: '7æ—¥é€£ç¶šã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸ',
    type: 'gold',
    iconClass: 'fa-fire',
    isUnlocked: false,
  },
]

// =====================================================
// ãƒ¬ãƒ™ãƒ«ãƒ»çµŒé¨“å€¤è¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// =====================================================

const calculateLevel = (experience: number): number => {
  return Math.floor(experience / 100) + 1
}

const calculateExperienceToNext = (experience: number): number => {
  const currentLevel = calculateLevel(experience)
  const nextLevelExp = currentLevel * 100
  return nextLevelExp - experience
}

const calculateRequiredExp = (level: number): number => {
  return (level - 1) * 100
}

// =====================================================
// Zustandãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆã‚¢
// =====================================================

export const useUserStore = create<UserState>()(
  devtools(
    immer(
      persist(
        (set, get) => ({
          // åˆæœŸçŠ¶æ…‹
          profileData: { ...defaultProfileData },
          extendedStats: null,
          achievements: [...predefinedAchievements],
          recentActivities: [],
          isLoading: false,
          isSaving: false,
          error: null,
          lastSyncTime: null,
          isInitialized: false,

          // =====================================================
          // åˆæœŸåŒ–
          // =====================================================
          initialize: async (userId: string) => {
            set((state) => {
              state.isLoading = true
              state.error = null
            })

            try {
              // é–‹ç™ºãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
              if (process.env.NODE_ENV === 'development') {
                console.log('ðŸ”§ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰: userStoreã‚’ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã§åˆæœŸåŒ–')
                
                set((state) => {
                  state.profileData = { ...defaultProfileData, nickname: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼' }
                  state.extendedStats = { ...defaultExtendedStats, userId }
                  state.achievements = predefinedAchievements.map((a: Achievement) => ({ ...a, isUnlocked: false }))
                  state.recentActivities = []
                  state.isInitialized = true
                  state.lastSyncTime = new Date().toISOString()
                  state.error = 'é–‹ç™ºãƒ¢ãƒ¼ãƒ‰: Supabaseè¨­å®šãªã—ã§å‹•ä½œä¸­'
                })
                
                return
              }

              const supabase = createBrowserSupabaseClient()

              // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
              const { data: profile } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('user_id', userId)
                .single()

              if (profile) {
                set((state) => {
                  state.profileData = {
                    nickname: profile.nickname || 'å†’é™ºè€…',
                    character: profile.character || '',
                    skills: profile.skills || [],
                    weakness: profile.weakness || '',
                    favoritePlace: profile.favorite_place || '',
                    energyCharge: profile.energy_charge || '',
                    companion: profile.companion || '',
                    catchphrase: profile.catchphrase || '',
                    message: profile.message || '',
                    avatarUrl: profile.avatar_url || '',
                    profileCompletion: 0, // å¾Œã§è¨ˆç®—
                  }
                })
              }

              // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—
              const { data: stats } = await supabase
                .from('user_extended_stats')
                .select('*')
                .eq('user_id', userId)
                .single()

              if (stats) {
                set((state) => {
                  state.extendedStats = {
                    userId: stats.user_id,
                    loginCount: stats.login_count || 0,
                    lastLoginDate: stats.last_login_date || '',
                    totalPlayTime: stats.total_play_time || 0,
                    level: stats.level || 1,
                    experience: stats.experience || 0,
                    experienceToNext: calculateExperienceToNext(stats.experience || 0),
                    questsCompleted: stats.quests_completed || 0,
                    questsInProgress: stats.quests_in_progress || 0,
                    currentStreak: stats.current_streak || 0,
                    maxStreak: stats.max_streak || 0,
                    achievementCount: stats.achievement_count || 0,
                    goldBadges: stats.gold_badges || 0,
                    silverBadges: stats.silver_badges || 0,
                    bronzeBadges: stats.bronze_badges || 0,
                    createdAt: stats.created_at || new Date().toISOString(),
                    updatedAt: stats.updated_at || new Date().toISOString(),
                  }
                })
              } else {
                // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                const newStats = { ...defaultExtendedStats, userId }
                await supabase
                  .from('user_extended_stats')
                  .insert(newStats)
                
                set((state) => {
                  state.extendedStats = newStats
                })
              }

              // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
              const { data: userAchievements } = await supabase
                .from('user_achievements')
                .select('achievement_id, unlocked_at')
                .eq('user_id', userId)

              if (userAchievements && userAchievements.length > 0) {
                set((state) => {
                  state.achievements = state.achievements.map(achievement => ({
                    ...achievement,
                    isUnlocked: userAchievements.some(ua => ua.achievement_id === achievement.id),
                    unlockedAt: userAchievements.find(ua => ua.achievement_id === achievement.id)?.unlocked_at,
                  }))
                })
              }

              // æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å–å¾—
              const { data: activities } = await supabase
                .from('user_activities')
                .select('*')
                .eq('user_id', userId)
                .order('timestamp', { ascending: false })
                .limit(20)

              if (activities) {
                set((state) => {
                  state.recentActivities = activities.map(activity => ({
                    id: activity.id,
                    userId: activity.user_id,
                    activityType: activity.activity_type,
                    description: activity.description,
                    experienceGained: activity.experience_gained,
                    timestamp: activity.timestamp,
                  }))
                })
              }

              // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œæˆåº¦ã‚’è¨ˆç®—
              const completion = get().calculateProfileCompletion()
              set((state) => {
                state.profileData.profileCompletion = completion
                state.isInitialized = true
                state.lastSyncTime = new Date().toISOString()
              })

            } catch (error) {
              console.warn('âš ï¸ SupabaseåˆæœŸåŒ–å¤±æ•—ã€é–‹ç™ºãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™:', error)
              
              // é–‹ç™ºç’°å¢ƒã§ã®ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼ˆSupabaseã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
              set((state) => {
                state.profileData = { ...defaultProfileData, nickname: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼' }
                state.extendedStats = { ...defaultExtendedStats, userId }
                state.achievements = predefinedAchievements.map((a: Achievement) => ({ ...a, isUnlocked: false }))
                state.recentActivities = []
                state.isInitialized = true
                state.lastSyncTime = new Date().toISOString()
                state.error = 'é–‹ç™ºãƒ¢ãƒ¼ãƒ‰: Supabaseã‚¨ãƒ©ãƒ¼ã®ãŸã‚ãƒ¢ãƒƒã‚¯å‹•ä½œä¸­'
              })
              console.log('ðŸ”§ ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰: userStoreåˆæœŸåŒ–å®Œäº†')
            } finally {
              set((state) => {
                state.isLoading = false
              })
            }
          },

          // =====================================================
          // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
          // =====================================================
          updateProfile: async (updates: Partial<ProfileData>) => {
            const { extendedStats } = get()
            if (!extendedStats?.userId) {
              const errorMessage = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
              set((state) => {
                state.error = errorMessage
              })
              return { success: false, error: errorMessage }
            }

            set((state) => {
              state.isSaving = true
              state.error = null
            })

            try {
              const supabase = createBrowserSupabaseClient()

              // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
              set((state) => {
                Object.assign(state.profileData, updates)
              })

              // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œæˆåº¦ã‚’å†è¨ˆç®—
              const completion = get().calculateProfileCompletion()
              set((state) => {
                state.profileData.profileCompletion = completion
              })

              // Supabaseã«ä¿å­˜
              const profileToSave = {
                user_id: extendedStats.userId,
                nickname: get().profileData.nickname,
                character: get().profileData.character,
                skills: get().profileData.skills,
                weakness: get().profileData.weakness,
                favorite_place: get().profileData.favoritePlace,
                energy_charge: get().profileData.energyCharge,
                companion: get().profileData.companion,
                catchphrase: get().profileData.catchphrase,
                message: get().profileData.message,
                avatar_url: get().profileData.avatarUrl,
                profile_completion: completion,
                updated_at: new Date().toISOString(),
              }

              await supabase
                .from('user_profiles')
                .upsert(profileToSave)

              // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¨˜éŒ²
              await get().recordActivity('profile_update', 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 5)

              // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œæˆå®Ÿç¸¾ã‚’ãƒã‚§ãƒƒã‚¯
              if (completion === 100) {
                await get().unlockAchievement('profile_complete')
              }

              set((state) => {
                state.lastSyncTime = new Date().toISOString()
              })

              return { success: true }

            } catch (error) {
              const errorMessage = error instanceof Error ? error.message : 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'
              set((state) => {
                state.error = errorMessage
              })
              return { success: false, error: errorMessage }
            } finally {
              set((state) => {
                state.isSaving = false
              })
            }
          },

          // =====================================================
          // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°
          // =====================================================
          updateStats: async (updates: Partial<ExtendedUserStats>) => {
            const { extendedStats } = get()
            if (!extendedStats) {
              const errorMessage = 'çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“'
              set((state) => {
                state.error = errorMessage
              })
              return { success: false, error: errorMessage }
            }

            set((state) => {
              state.isSaving = true
              state.error = null
            })

            try {
              const supabase = createBrowserSupabaseClient()

              // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
              set((state) => {
                if (state.extendedStats) {
                  Object.assign(state.extendedStats, {
                    ...updates,
                    updatedAt: new Date().toISOString(),
                  })
                }
              })

              // Supabaseã«ä¿å­˜
              await supabase
                .from('user_extended_stats')
                .update({
                  ...updates,
                  updated_at: new Date().toISOString(),
                })
                .eq('user_id', extendedStats.userId)

              set((state) => {
                state.lastSyncTime = new Date().toISOString()
              })

              return { success: true }

            } catch (error) {
              const errorMessage = error instanceof Error ? error.message : 'çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'
              set((state) => {
                state.error = errorMessage
              })
              return { success: false, error: errorMessage }
            } finally {
              set((state) => {
                state.isSaving = false
              })
            }
          },

          // =====================================================
          // çµŒé¨“å€¤è¿½åŠ ï¼ˆãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—åˆ¤å®šä»˜ãï¼‰
          // =====================================================
          addExperience: async (amount: number, reason?: string) => {
            const { extendedStats } = get()
            if (!extendedStats) {
              return { success: false, error: 'çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“' }
            }

            const newExperience = extendedStats.experience + amount
            const oldLevel = extendedStats.level
            const newLevel = calculateLevel(newExperience)
            const levelUp = newLevel > oldLevel

            // çµ±è¨ˆã‚’æ›´æ–°
            const statsUpdate = {
              experience: newExperience,
              level: newLevel,
              experienceToNext: calculateExperienceToNext(newExperience),
            }

            const result = await get().updateStats(statsUpdate)

            if (result.success) {
              // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¨˜éŒ²
              if (reason) {
                await get().recordActivity('quest_complete', reason, amount)
              }

              // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ãŸå ´åˆ
              if (levelUp) {
                await get().recordActivity('level_up', `ãƒ¬ãƒ™ãƒ«${newLevel}ã«åˆ°é”ï¼`, 0)
                
                // ãƒ¬ãƒ™ãƒ«é–¢é€£ã®å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
                if (newLevel >= 10) {
                  await get().unlockAchievement('level_10')
                }
              }

              return { success: true, levelUp }
            }

            return result
          },

          // =====================================================
          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£è¨˜éŒ²
          // =====================================================
          recordActivity: async (activityType: UserActivity['activityType'], description: string, experienceGained?: number) => {
            const { extendedStats } = get()
            if (!extendedStats?.userId) return

            try {
              const supabase = createBrowserSupabaseClient()

              const activity: Omit<UserActivity, 'id'> = {
                userId: extendedStats.userId,
                activityType,
                description,
                experienceGained,
                timestamp: new Date().toISOString(),
              }

              const { data } = await supabase
                .from('user_activities')
                .insert(activity)
                .select()
                .single()

              if (data) {
                set((state) => {
                  state.recentActivities = [data as UserActivity, ...state.recentActivities.slice(0, 19)]
                })
              }

            } catch (error) {
              console.error('ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error)
            }
          },

          // =====================================================
          // å®Ÿç¸¾è§£é™¤
          // =====================================================
          unlockAchievement: async (achievementId: string) => {
            const { extendedStats, achievements } = get()
            if (!extendedStats?.userId) {
              return { success: false, error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' }
            }

            const achievement = achievements.find(a => a.id === achievementId)
            if (!achievement || achievement.isUnlocked) {
              return { success: false, error: 'å®Ÿç¸¾ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€æ—¢ã«è§£é™¤æ¸ˆã¿ã§ã™' }
            }

            try {
              const supabase = createBrowserSupabaseClient()
              const unlockedAt = new Date().toISOString()

              // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²
              await supabase
                .from('user_achievements')
                .insert({
                  user_id: extendedStats.userId,
                  achievement_id: achievementId,
                  unlocked_at: unlockedAt,
                })

              // ã‚¹ãƒˆã‚¢çŠ¶æ…‹ã‚’æ›´æ–°
              set((state) => {
                const achievementIndex = state.achievements.findIndex(a => a.id === achievementId)
                if (achievementIndex !== -1) {
                  state.achievements[achievementIndex].isUnlocked = true
                  state.achievements[achievementIndex].unlockedAt = unlockedAt
                }

                // ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
                if (state.extendedStats) {
                  state.extendedStats.achievementCount += 1
                  switch (achievement.type) {
                    case 'gold':
                      state.extendedStats.goldBadges += 1
                      break
                    case 'silver':
                      state.extendedStats.silverBadges += 1
                      break
                    case 'bronze':
                      state.extendedStats.bronzeBadges += 1
                      break
                  }
                }
              })

              // çµ±è¨ˆã‚’æ›´æ–°
              await get().updateStats({
                achievementCount: extendedStats.achievementCount + 1,
                goldBadges: extendedStats.goldBadges + (achievement.type === 'gold' ? 1 : 0),
                silverBadges: extendedStats.silverBadges + (achievement.type === 'silver' ? 1 : 0),
                bronzeBadges: extendedStats.bronzeBadges + (achievement.type === 'bronze' ? 1 : 0),
              })

              // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¨˜éŒ²
              await get().recordActivity('quest_complete', `å®Ÿç¸¾ã€Œ${achievement.title}ã€ã‚’è§£é™¤ã—ã¾ã—ãŸï¼`, 20)

              return { success: true }

            } catch (error) {
              const errorMessage = error instanceof Error ? error.message : 'å®Ÿç¸¾è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'
              set((state) => {
                state.error = errorMessage
              })
              return { success: false, error: errorMessage }
            }
          },

          // =====================================================
          // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œæˆåº¦è¨ˆç®—
          // =====================================================
          calculateProfileCompletion: () => {
            const { profileData } = get()
            const fields = [
              'nickname', 'character', 'weakness', 'favoritePlace', 
              'energyCharge', 'companion', 'catchphrase', 'message'
            ]
            
            let filledCount = 0
            
            fields.forEach(field => {
              const value = profileData[field as keyof ProfileData]
              if (field === 'skills') {
                if (Array.isArray(value) && value.length > 0) filledCount++
              } else if (value && String(value).trim() !== '') {
                filledCount++
              }
            })
            
            // ã‚¹ã‚­ãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆ¥é€”ãƒã‚§ãƒƒã‚¯
            if (profileData.skills.length > 0) {
              filledCount++
            }
            
            const totalFields = fields.length + 1 // +1 for skills
            return Math.round((filledCount / totalFields) * 100)
          },

          // =====================================================
          // è‡ªå‹•ä¿å­˜
          // =====================================================
          autoSave: async () => {
            const { profileData, extendedStats, isSaving } = get()
            
            if (isSaving || !extendedStats?.userId) return

            try {
              // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
              localStorage.setItem('claft-profile-data', JSON.stringify(profileData))
              localStorage.setItem('claft-last-save', new Date().toISOString())

              // å®šæœŸçš„ã«Supabaseã¨åŒæœŸ
              const lastSync = get().lastSyncTime
              const now = new Date()
              const lastSyncTime = lastSync ? new Date(lastSync) : new Date(0)
              const timeDiff = now.getTime() - lastSyncTime.getTime()
              
              // 5åˆ†ä»¥ä¸ŠçµŒéŽã—ã¦ã„ãŸã‚‰åŒæœŸ
              if (timeDiff > 5 * 60 * 1000) {
                await get().syncWithSupabase()
              }

            } catch (error) {
              console.error('è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error)
            }
          },

          // =====================================================
          // Supabaseã¨ã®åŒæœŸ
          // =====================================================
          syncWithSupabase: async () => {
            const { profileData, extendedStats } = get()
            if (!extendedStats?.userId) return

            try {
              const result = await get().updateProfile(profileData)
              if (result.success) {
                set((state) => {
                  state.lastSyncTime = new Date().toISOString()
                })
              }
            } catch (error) {
              console.error('SupabaseåŒæœŸã‚¨ãƒ©ãƒ¼:', error)
            }
          },

          // =====================================================
          // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒªã‚»ãƒƒãƒˆ
          // =====================================================
          resetProfile: () => {
            set((state) => {
              state.profileData = { ...defaultProfileData }
              state.profileData.profileCompletion = 0
            })
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚‚å‰Šé™¤
            localStorage.removeItem('claft-profile-data')
          },

          // =====================================================
          // ã‚¨ãƒ©ãƒ¼ã‚¯ãƒªã‚¢
          // =====================================================
          clearError: () => {
            set((state) => {
              state.error = null
            })
          },
        }),
        {
          name: 'claft-user-store',
          partialize: (state) => ({
            profileData: state.profileData,
            lastSyncTime: state.lastSyncTime,
            isInitialized: state.isInitialized,
          })
        }
      )
    ),
    {
      name: 'user-store',
      enabled: process.env.NODE_ENV === 'development'
    }
  )
)

// =====================================================
// ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆä¾¿åˆ©é–¢æ•°ï¼‰
// =====================================================

export const useUserProfile = () => {
  const store = useUserStore()
  return {
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿
    profileData: store.profileData,
    profileCompletion: store.profileData.profileCompletion,
    
    // çŠ¶æ…‹
    isLoading: store.isLoading,
    isSaving: store.isSaving,
    error: store.error,
    isInitialized: store.isInitialized,
    
    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    updateProfile: store.updateProfile,
    resetProfile: store.resetProfile,
    autoSave: store.autoSave,
    clearError: store.clearError,
  }
}

export const useUserStats = () => {
  const store = useUserStore()
  return {
    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
    stats: store.extendedStats,
    achievements: store.achievements,
    recentActivities: store.recentActivities,
    
    // æ´¾ç”ŸçŠ¶æ…‹
    unlockedAchievements: store.achievements.filter(a => a.isUnlocked),
    experienceProgress: store.extendedStats ? 
      (store.extendedStats.experience / (store.extendedStats.level * 100)) * 100 : 0,
    
    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    updateStats: store.updateStats,
    addExperience: store.addExperience,
    unlockAchievement: store.unlockAchievement,
    recordActivity: store.recordActivity,
  }
}

export const useUserActions = () => {
  const store = useUserStore()
  return {
    initialize: store.initialize,
    updateProfile: store.updateProfile,
    updateStats: store.updateStats,
    addExperience: store.addExperience,
    unlockAchievement: store.unlockAchievement,
    recordActivity: store.recordActivity,
    calculateProfileCompletion: store.calculateProfileCompletion,
    autoSave: store.autoSave,
    syncWithSupabase: store.syncWithSupabase,
    resetProfile: store.resetProfile,
    clearError: store.clearError,
  }
}

// =====================================================
// é–‹ç™ºç”¨ãƒ‡ãƒãƒƒã‚°é–¢æ•°
// =====================================================

export const useUserDebug = () => {
  const store = useUserStore()
  
  if (process.env.NODE_ENV !== 'development') {
    return null
  }
  
  return {
    // é–‹ç™ºç”¨ã®ãƒ†ã‚¹ãƒˆé–¢æ•°
    addTestExperience: () => store.addExperience(50, 'ãƒ†ã‚¹ãƒˆçµŒé¨“å€¤'),
    unlockAllAchievements: async () => {
      for (const achievement of store.achievements) {
        if (!achievement.isUnlocked) {
          await store.unlockAchievement(achievement.id)
        }
      }
    },
    resetAllData: () => {
      store.resetProfile()
      // ãã®ä»–ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†
    },
    getState: () => ({
      profileData: store.profileData,
      extendedStats: store.extendedStats,
      achievements: store.achievements,
      recentActivities: store.recentActivities,
    }),
  }
}

export default useUserStore 